<div id="login">
	<h2>JIRA Credentials</h2>
	<table id="login">
	    <tr>
		<td>Username</td>
		<td><input type="text" id="username" name="username" /></td>
	    </tr>
	    <tr>
		<td>Password</td>
		<td><input type="password" id="password" name="password" /></td>
	    </tr>
	    <tr>
		<td>Sprint</td>
		<td><input type="text" id="sprint" name="sprint" /></td>
	    </tr>
	    <tr>
		<td>&nbsp;</td>
		<td style="text-align:right;"><input type="button" value="Update" id="update" /></td>
	    </tr>
	</table>

	<h2>Options</h2>
	<input id="flush" type="button" value="Flush Issues" />
</div>

<div id="legend">
    <table>
	<tr>
	    <th>User</th>
	    <th>Color</th>
	</tr>
	<tr id="users">

	</tr>
    </table>
</div>

<table id="issueboard">	
    <tr>
	<th>Open</th>
	<th>In Progress</th>
	<th>Review</th>
	<th>SQL Review</th>
	<th>Merge</th>
	<th>Test</th>
	<th>System Test</th>
	<th>Rework</th>
	<th>Blocked</th>
	<th>Done</th>
    </tr>
    <tr>
	<td id="open" class="border_right issue_section"></td>
	<td id="in_progress" class="border_right issue_section"></td>
	<td id="review" class="border_right issue_section"></td>
	<td id="sql_review" class="border_right issue_section"></td>
	<td id="merge" class="border_right issue_section"></td>
	<td id="test" class="border_right issue_section"></td>
	<td id="system_test" class="border_right issue_section"></td>
	<td id="rework" class="border_right issue_section"></td>
	<td id="blocked" class="border_right issue_section"></td>
	<td id="done" class="issue_section"></td>
    </tr>
</table>

<div id="overlay_container" style="display:none;">
    <div id="loading_overlay"></div>
    <div id="loading">Loading...</div>
</div>

<script>
var ticket_array = [];
var assignee_array = new observableArray();

assignee_array.onNewItem = function(key){
    $('#legend table').append('<tr class="legend_user"><td>' + key + '</td><td class="' + key + '">&nbsp;</td></tr>');
};

function assigneeColourize() {
    for (key in assignee_array.data) {
	if ($('.' + key))
	    $('.' + key).css('background-color', stringToColor(key));
    }
}

$(document).ready(function(){

    $('#update').click(function() {
	queryIssues();

	$('#password').val('');
    });

    $('#flush').click(function(){
	$.get('flush_issues', function(data){
	    if (data.json_message == "Issues flushed.") {
		$('.issue_section').html('');
		ticket_array = [];
		assignee_array.data = {};
	    }
	});

	$('#legend table tr.legend_user').remove();
    });

    $('.issue_section').droppable({
        drop: function( event, ui ) {
	    var ticket_id = ui.draggable.attr('id');
	    var section = $(this).attr('id');
	    var title = $('#' + ticket_id + '_title').html();
	    var assignee = $('#' + ticket_id + '_assignee').html();

	    $.post('update_issue', { id: ticket_id, section: section, title: title, assignee: assignee }, function(data) {
		if (data.json_data.errors) {
		    alert(data.json_data.errors);
		}
	    });

	    ui.draggable.remove();
	    ui.draggable.removeAttr('style');
	    $(this).append(ui.draggable);

	    // Re-init draggable
	    $('.ticket_block').draggable();
	}
    });

    $.get('get_issues', function(data) {
	if (data.json_data.errors) {
	    alert(data.json_data.errors);
	}
	else {
	    for (var i = 0; i < data.json_data.tickets.length; i++) {
		var ticket_data = data.json_data.tickets[i];
		ticket_array.push(new ticket(ticket_data.id, ticket_data.title, ticket_data.assignee));
		assignee_array.push(ticket_data.assignee, 1);
		$('#' + ticket_data.section).append(ticket_array[ticket_array.length - 1].toObj()); 
	    }

	    assigneeColourize();
	}
    });
});

function queryIssues() {
    /*
	Authentication
    */
    $('#overlay_container').show();

    var username = $('#username').val();
    var password = $('#password').val();
    var sprint = $('#sprint').val();

    $.post('/curl/get_issues', { username: username, password: password, sprint: sprint }, function(data) {
	    var issues = data.json_data.issues;

	    for (var i = 0; i < issues.length; i++) {
		var issue = issues[i];
	
		if (issue.fields.assignee.name != "procter") {
		    var ticketFound = false;

		    for (var j = 0; j < ticket_array.length; j++) {
			if (ticket_array[j].getId() == issue.key) {
			    ticketFound = true;
			}
		    }

		    if (!ticketFound) {
			ticket_array.push(new ticket(issue.key, issue.fields.summary, issue.fields.assignee.name));
			$('#' + convertJIRAStatus(issue.fields.status.name)).append(ticket_array[ticket_array.length - 1].toObj());
			assignee_array.push(issue.fields.assignee.name, 1);

			$.post('update_issue', { id: issue.key, section: convertJIRAStatus(issue.fields.status.name), title: issue.fields.summary, assignee: issue.fields.assignee.name }, function(data) {
			    if (data.json_data.errors) {
				alert(data.json_data.errors);
			    }
			});
		    }
		}
	    }

	    $('#overlay_container').hide();
	    assigneeColourize();
	},
	'json'
    );
}

function convertJIRAStatus(jiraStatus) {
    return jiraStatus.toLowerCase().replace(/\s/, "_");
}
</script>
